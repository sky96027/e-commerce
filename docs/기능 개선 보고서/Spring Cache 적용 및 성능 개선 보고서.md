### 캐시 도입 이유

읽기 트래픽을 비싼 자원인 DB 대신 값싸고 빠른 메로리로 이동시킴으로써 DB에 대한 부하를 분산하여 지연 절감, 비용 절감, 병목 완화, 안전성 향상에 유효함.

### 캐시 적용 대상

1. 상품 상세 조회

   읽기 빈도 : 매우 높음

   변경 빈도 : 낮음

   정합성 위험도 : 중간

2. 상품 옵션 조회

   읽기 빈도 : 높음

   변경 빈도 : 높음(Stock)

   정합성 위험도 : 중간

3. 주문 조회

   읽기 빈도 : 중간

   변경 빈도 : 중간(상태 전이)

   정합성 위험도 : 중간

4. 쿠폰 정책 조회

   읽기 빈도 : 중간

   변경 빈도 : 매우 낮음

   정합성 위험도 : 중간

5. 유저의 쿠폰 조회

   읽기 빈도 : 중간~높음

   변경 빈도 : 중간~높음(발급/사용/만료)

   정합성 위험도 : 높음

6. 인기 상품 조회

   읽기 빈도 : 높음

   변경 빈도 : 매우 낮음(배치 주기)

   정합성 위험도 : 낮음

7. 거래 내역 조회

   읽기 빈도 : 중간

   변경 빈도 : 중간(충전, 사용)

   정합성 위험도 : 낮음


### 구현

**Spring Cache 설정 추가**

https://github.com/sky96027/e-commerce/commit/4ce9e3c74535c77413004a489b390929221ad245

**Spring Cache 관리 클래스, Cache 적용 대상 Invalidator, 캐시 무효화 event 추가**

https://github.com/sky96027/e-commerce/commit/9e4f55891eea2a8905c8f70843c84101fd7b0af3

**캐시 실제 적용, 캐시 무효화 이벤트 적용**

https://github.com/sky96027/e-commerce/commit/0cc5861781dd41da8af4dd062babe592ce392502

**재고 차감 로직에 Redis Hash 적용**

https://github.com/sky96027/e-commerce/commit/6fb6f29bb00f85de7f6f4ad7e3793165395b5f9b

**캐시 무효화 이벤트 테스트, 캐시 성능 테스트, 캐시 저장 테스트, 해시 기반 재고 캐시 테스트 추가**

https://github.com/sky96027/e-commerce/commit/cbdbb4cb2565a55b21b668359f14262df16d12ef

### 구현된 캐시 정리

| 캐시 | TTL | 읽기 빈도 | 변경/이벤트 빈도 | 정합성 위험도 | 스탬피드 위험 | 무효화 전략(권장) | 실시간 재고 연계 | 메모 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| **product:detail** | **60분** | 매우 높음 | 낮음 | 중간 | 높음 | 상품 수정 시 정밀 evict | 해당 없음 | 장TTL이면 만료 동시폭주 주의 → single-flight + TTL 지터(±10%). |
| **product:options** | **10분** | 높음 | 높음(재고 관리) | 중간 | 중간 | 옵션 변경 이벤트 정밀 evict | 통합 캐시 (메타데이터 + 재고 함께 저장)
Redis Hash: stock:prod:{productId} (재고 연산용) | DB에서 메타+재고 통합 조회 후 캐시. 재고 변경 시 StockChangedEvent로 캐시 무효화.
Redis Hash: 재고 차감/증가 연산용으로만 사용 (Lua 스크립트 원자성 보장). |
| **order:summary** | **2분** | 중간 | 중간(상태 전이) | 중간 | 낮음 | 상태 전이 시 즉시 evict | 해당 없음 | 이벤트 evict가 안정적으로 동작하면 2분 유지 OK. |
| **coupon:policy** | **60분** | 중간 | 매우 낮음 | 중간 | 중간 | 정책 변경 시 정밀 evict | 해당 없음 | 장TTL 키는 **지터(±10%)**로 동시 만료 분산. |
| **coupon:userSummary** | **5분** | 중간~높음 | 중간~높음(발급/사용/만료) | 높음 | 중간 | 발급/사용/회수 시 userId 단위 evict | 해당 없음 | 주문 단계 정확도 중요하면 5분→30–60초로 단축 고려. |
| **popular:top** | **24시간** | 높음 | 매우 낮음(배치 주기) | 낮음 | 낮음 | 배치 완료 후 신규 키 전환 | 해당 없음 | 인기 상품 기능 미구현 |
| **tx:recent** | **5분** | 중간 | 중간(입출금) | 낮음 | 낮음 | 입출금 발생 시 userId evict | 해당 없음 |  |

### 결과

캐싱 전 후 성능 테스트

=== 거래 내역 조회 캐시 성능 비교 ===

캐시 미스(DB조회) : **19ms**

![거래 내역 캐시 미스](../images/캐싱%20보고서%20이미지/1.png)

캐시 히트(메모리) : **9ms**

![거래 내역 캐시 히트](../images/캐싱%20보고서%20이미지/2.png)

**성능 향상: 약 2.11배**

=== 주문 조회 캐시 성능 비교 ===
캐시 미스 (DB 조회): **37ms**

![주문 캐시 미스](../images/캐싱%20보고서%20이미지/3.png)

캐시 히트 (메모리) : **12ms**

![주문 캐시 히트](../images/캐싱%20보고서%20이미지/4.png)

**성능 향상: 약 3.08배**

=== 쿠폰 정책 조회 캐시 성능 비교 ===
캐시 미스 (DB 조회): **24ms**

![쿠폰 정책 캐시 미스](../images/캐싱%20보고서%20이미지/5.png)

캐시 히트 (메모리): **10ms**

![쿠폰 정책 캐시 히트](../images/캐싱%20보고서%20이미지/6.png)

**성능 향상: 약 2.4배**

=== 상품 상세(상품+상품옵션) 조회 캐시 성능 비교 ===
캐시 미스 (DB 조회): **17 ms**

![상품 상세 캐시 미스](../images/캐싱%20보고서%20이미지/7.png)

캐시 히트 (메모리): **12 ms**

![상품 상세 캐시 히트](../images/캐싱%20보고서%20이미지/8.png)

**성능 향상: 약 1.42배**

=== 사용자 쿠폰 요약 조회 캐시 성능 비교 ===
캐시 미스 (DB 조회): **11 ms**

![사용자 쿠폰 캐시 미스](../images/캐싱%20보고서%20이미지/9.png)

캐시 히트 (메모리): **4 ms**

![사용자 쿠폰 캐시 히트](../images/캐싱%20보고서%20이미지/10.png)

**성능 향상: 약 2.75배**